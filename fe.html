<script>
    const WS_URL = "ws://localhost:3000/ws/chat";
    const ws = new WebSocket(WS_URL);
</script>

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Streaming Chat Demo</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 0;
                display: flex;
                flex-direction: column;
                height: 100vh;
            }
            #chat {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
                background: #f9fafb;
            }
            .msg {
                padding: 0.5rem 1rem;
                margin: 0.25rem 0;
                border-radius: 8px;
                max-width: 70%;
                white-space: pre-wrap;
            }
            .user {
                background: #3b82f6;
                color: white;
                margin-left: auto;
            }
            .ai {
                background: #e5e7eb;
                color: #111827;
                margin-right: auto;
            }
            .title {
                font-weight: bold;
                margin-bottom: 0.25rem;
            }
            .haiku {
                font-style: italic;
                color: #374151;
                margin-top: 0.25rem;
            }
            form {
                display: flex;
                border-top: 1px solid #ddd;
            }
            input {
                flex: 1;
                padding: 0.5rem;
                border: none;
                outline: none;
            }
            button {
                padding: 0.5rem 1rem;
                background: #3b82f6;
                color: white;
                border: none;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div id="chat"></div>
        <form id="form">
            <input id="input" placeholder="Type your message..." />
            <button>Send</button>
        </form>

        <script>
            const chat = document.getElementById("chat");
            const form = document.getElementById("form");
            const input = document.getElementById("input");

            // let ws = new WebSocket("ws://127.0.0.1:3000/ws/chat");
            let streamingMessage = null; // holds the currently streaming Bot message

            function renderMessage(msg, streaming = false) {
                if (!msg.element) {
                    // create the container
                    const wrapper = document.createElement("div");
                    wrapper.className = "msg " + msg.role;
                    if (streaming) wrapper.id = "streaming";

                    // title
                    const titleDiv = document.createElement("div");
                    titleDiv.className = "title";
                    wrapper.appendChild(titleDiv);

                    // content
                    const contentDiv = document.createElement("div");
                    wrapper.appendChild(contentDiv);

                    // haiku
                    const haikuDiv = document.createElement("div");
                    haikuDiv.className = "haiku";
                    wrapper.appendChild(haikuDiv);

                    chat.appendChild(wrapper);
                    msg.element = wrapper;
                    msg.titleDiv = titleDiv;
                    msg.contentDiv = contentDiv;
                    msg.haikuDiv = haikuDiv;
                }

                // update fields
                msg.titleDiv.textContent = msg.title || "";
                msg.contentDiv.textContent = msg.content || "";
                msg.haikuDiv.textContent = msg.haiku || "";

                chat.scrollTop = chat.scrollHeight;
            }

            form.onsubmit = (e) => {
                e.preventDefault();
                const text = input.value.trim();
                if (!text) return;
                const userMsg = { role: "user", content: text };
                chat.appendChild(
                    (() => {
                        const div = document.createElement("div");
                        div.className = "msg user";
                        div.textContent = text;
                        return div;
                    })(),
                );
                ws.send(
                    JSON.stringify({ type: "user_message", content: text }),
                );
                input.value = "";
            };

            ws.onmessage = (event) => {
                const resp = JSON.parse(event.data);
                const msg = resp.message || {};

                if (resp.type === "start") {
                    streamingMessage = {
                        role: "ai",
                        title: null,
                        content: null,
                        haiku: null,
                    };
                } else if (resp.type === "stream") {
                    if (!streamingMessage) return; // safety
                    // merge chunked fields
                    streamingMessage.title =
                        msg.title ?? streamingMessage.title;
                    streamingMessage.content =
                        msg.content ?? streamingMessage.content;
                    streamingMessage.haiku =
                        msg.haiku ?? streamingMessage.haiku;
                    renderMessage(streamingMessage, true);
                } else if (resp.type === "end") {
                    if (!streamingMessage) return;
                    streamingMessage.title =
                        msg.title ?? streamingMessage.title;
                    streamingMessage.content =
                        msg.content ?? streamingMessage.content;
                    streamingMessage.haiku =
                        msg.haiku ?? streamingMessage.haiku;
                    renderMessage(streamingMessage, false);
                    streamingMessage = null;
                } else if (resp.type === "error") {
                    const errorMsg = {
                        role: "ai",
                        title: null,
                        content: msg.content || "Error",
                        haiku: null,
                    };
                    renderMessage(errorMsg, false);
                }
            };
        </script>
    </body>
</html>
